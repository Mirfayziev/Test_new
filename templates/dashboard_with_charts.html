{% extends "base.html" %}

{% block page_title %}Dashboard - Boshqaruv Paneli{% endblock %}

{% block extra_css %}
<style>
.chart-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    border: 1px solid var(--border-gray);
    margin-bottom: 1.5rem;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.chart-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--dark-navy);
}

canvas {
    max-height: 300px;
}
</style>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1" style="color: var(--dark-navy);">Xush kelibsiz, {{ current_user.full_name }}!</h3>
                        <p class="text-muted mb-0">Bugungi kunlik statistika va modullar</p>
                    </div>
                    <div class="text-end">
                        <h5 class="mb-0 text-primary" id="currentDate"></h5>
                        <p class="text-muted mb-0" id="currentTime"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4 fade-in">
    <!-- Jami Topshiriqlar -->
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card orange-card">
            <div class="stat-icon orange">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="stat-number">{{ stats.total_tasks }}</div>
            <div class="stat-label">Jami topshiriqlar</div>
        </div>
    </div>
    
    <!-- Bajarilayotgan Topshiriqlar -->
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card green-card">
            <div class="stat-icon green">
                <i class="bi bi-arrow-repeat"></i>
            </div>
            <div class="stat-number">{{ stats.pending_tasks }}</div>
            <div class="stat-label">Bajarilayotgan topshiriqlar</div>
        </div>
    </div>
    
    <!-- Bajarilgan Topshiriqlar -->
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card pink-card">
            <div class="stat-icon pink">
                <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-number">{{ stats.completed_tasks }}</div>
            <div class="stat-label">Bajarilgan topshiriqlar</div>
        </div>
    </div>
    
    <!-- Mening Topshiriqlarim -->
    <div class="col-md-6 col-lg-3 mb-3">
        <div class="stat-card blue-card">
            <div class="stat-icon blue">
                <i class="bi bi-person-check"></i>
            </div>
            <div class="stat-number">{{ stats.my_tasks if stats.my_tasks else 0 }}</div>
            <div class="stat-label">Mening topshiriqlarim</div>
        </div>
    </div>
</div>

{% if current_user.role in ['admin', 'rahbar'] %}
<!-- Charts Section for Admin/Rahbar -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="bi bi-bar-chart"></i> Oylik Topshiriqlar Statistikasi
                </h5>
                <select class="form-select form-select-sm" style="width: auto;" id="monthFilter">
                    <option value="6">Oxirgi 6 oy</option>
                    <option value="12" selected>Oxirgi yil</option>
                </select>
            </div>
            <canvas id="tasksChart"></canvas>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="bi bi-pie-chart"></i> Topshiriqlar Holati
                </h5>
            </div>
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="bi bi-lightning"></i> Quyosh Panellari Ishlab Chiqarish
                </h5>
            </div>
            <canvas id="solarChart"></canvas>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="chart-card">
            <div class="chart-header">
                <h5 class="chart-title">
                    <i class="bi bi-people"></i> Xodimlar Bo'limlari Bo'yicha
                </h5>
            </div>
            <canvas id="employeeChart"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- Modules Grid -->
{% if current_user.role in ['admin', 'rahbar'] %}
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3" style="color: var(--dark-navy); font-weight: 700;">
            <i class="bi bi-grid-3x3-gap"></i> Tizim Modullari
        </h4>
    </div>
</div>

<div class="row slide-in-left">
    <!-- Topshiriqlar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('tasks') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #FF9500 0%, #FFB800 100%);">
                    <i class="bi bi-list-check"></i>
                </div>
                <div class="module-title">Topshiriqlar</div>
                <div class="module-count">{{ stats.total_tasks }}</div>
            </div>
        </a>
    </div>
    
    <!-- Avto Transport -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('vehicles') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <i class="bi bi-truck"></i>
                </div>
                <div class="module-title">Avto Transport</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Ijro -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('ijro') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%);">
                    <i class="bi bi-graph-up"></i>
                </div>
                <div class="module-title">Ijro</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Binolar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('buildings') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #007AFF 0%, #00A8FF 100%);">
                    <i class="bi bi-building"></i>
                </div>
                <div class="module-title">Binolar</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Yashil Makonlar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('green_spaces') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #00CC99 0%, #00FFAA 100%);">
                    <i class="bi bi-tree"></i>
                </div>
                <div class="module-title">Yashil Makonlar</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Quyosh Panellari -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('solar_panels') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #FF9500 0%, #FFD700 100%);">
                    <i class="bi bi-sun"></i>
                </div>
                <div class="module-title">Quyosh Panellari</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Xodimlar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('employees') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="bi bi-people"></i>
                </div>
                <div class="module-title">Xodimlar</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Autsorsing -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('outsourcing') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);">
                    <i class="bi bi-briefcase"></i>
                </div>
                <div class="module-title">Autsorsing</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Tashkilotlar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('organizations') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%);">
                    <i class="bi bi-bank"></i>
                </div>
                <div class="module-title">Tashkilotlar</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Mehmonlar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('guests') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
                    <i class="bi bi-person-badge"></i>
                </div>
                <div class="module-title">Mehmonlar</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Tabriknomalar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('congratulations') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="bi bi-gift"></i>
                </div>
                <div class="module-title">Tabriknomalar</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Shartnomalar -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('contracts') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="bi bi-file-earmark-text"></i>
                </div>
                <div class="module-title">Shartnomalar</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
    
    <!-- Ombor So'rovnomalari -->
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <a href="{{ url_for('warehouse') }}" style="text-decoration: none;">
            <div class="module-card">
                <div class="module-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="module-title">Ombor</div>
                <div class="module-count">0</div>
            </div>
        </a>
    </div>
</div>
{% endif %}

<!-- Recent Activity -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card border-0">
            <div class="card-header gradient">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> So'nggi Faoliyat
                </h5>
            </div>
            <div class="card-body">
                <div class="list-item">
                    <div class="list-item-icon">
                        <i class="bi bi-list-check"></i>
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">Yangi topshiriq yaratildi</div>
                        <div class="list-item-subtitle">5 daqiqa oldin</div>
                    </div>
                    <span class="badge badge-primary">Topshiriq</span>
                </div>
                
                <div class="list-item">
                    <div class="list-item-icon" style="background: var(--gradient-success);">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">Topshiriq bajarildi</div>
                        <div class="list-item-subtitle">1 soat oldin</div>
                    </div>
                    <span class="badge badge-success">Bajarildi</span>
                </div>
                
                <div class="list-item">
                    <div class="list-item-icon" style="background: var(--gradient-warning);">
                        <i class="bi bi-truck"></i>
                    </div>
                    <div class="list-item-content">
                        <div class="list-item-title">Transport yangilandi</div>
                        <div class="list-item-subtitle">2 soat oldin</div>
                    </div>
                    <span class="badge badge-warning">Transport</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card border-0">
            <div class="card-header gradient">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up"></i> Statistika
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-card border-0 shadow-none p-0">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Bajarilish foizi</span>
                            <span class="fw-bold text-success">
                                {% if stats.total_tasks > 0 %}
                                {{ (stats.completed_tasks * 100 / stats.total_tasks)|round|int }}%
                                {% else %}
                                0%
                                {% endif %}
                            </span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" style="width: {{ (stats.completed_tasks * 100 / stats.total_tasks)|round|int if stats.total_tasks > 0 else 0 }}%; background: var(--gradient-success);"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Jarayonda</span>
                            <span class="fw-bold text-warning">
                                {% if stats.total_tasks > 0 %}
                                {{ (stats.pending_tasks * 100 / stats.total_tasks)|round|int }}%
                                {% else %}
                                0%
                                {% endif %}
                            </span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" style="width: {{ (stats.pending_tasks * 100 / stats.total_tasks)|round|int if stats.total_tasks > 0 else 0 }}%; background: var(--gradient-warning);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    // Update time and date
    function updateDateTime() {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long'
        };
        const dateStr = now.toLocaleDateString('uz-UZ', options);
        const timeStr = now.toLocaleTimeString('uz-UZ');
        
        document.getElementById('currentDate').textContent = dateStr;
        document.getElementById('currentTime').textContent = timeStr;
    }
    
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // Charts (only for admin/rahbar)
    {% if current_user.role in ['admin', 'rahbar'] %}
    // Monthly Tasks Chart
    const tasksCtx = document.getElementById('tasksChart');
    if (tasksCtx) {
        new Chart(tasksCtx, {
            type: 'line',
            data: {
                labels: ['Yanvar', 'Fevral', 'Mart', 'Aprel', 'May', 'Iyun', 'Iyul', 'Avgust', 'Sentyabr', 'Oktyabr', 'Noyabr', 'Dekabr'],
                datasets: [{
                    label: 'Yangi topshiriqlar',
                    data: [12, 19, 15, 25, 22, 30, 28, 35, 32, 38, 42, 45],
                    borderColor: 'rgb(74, 110, 245)',
                    backgroundColor: 'rgba(74, 110, 245, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Bajarilgan',
                    data: [8, 15, 12, 20, 18, 25, 23, 30, 28, 33, 37, 40],
                    borderColor: 'rgb(0, 204, 153)',
                    backgroundColor: 'rgba(0, 204, 153, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Status Pie Chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'In Progress', 'Completed', 'Cancelled'],
                datasets: [{
                    data: [{{ stats.pending_tasks }}, {{ stats.total_tasks - stats.completed_tasks - stats.pending_tasks }}, {{ stats.completed_tasks }}, 0],
                    backgroundColor: [
                        'rgb(255, 149, 0)',
                        'rgb(0, 122, 255)',
                        'rgb(0, 204, 153)',
                        'rgb(255, 59, 48)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Solar Panel Production Chart
    const solarCtx = document.getElementById('solarChart');
    if (solarCtx) {
        new Chart(solarCtx, {
            type: 'bar',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                datasets: [{
                    label: 'Ishlab chiqarish (kW)',
                    data: [0, 2, 15, 25, 18, 5],
                    backgroundColor: 'rgba(255, 215, 0, 0.8)',
                    borderColor: 'rgb(255, 215, 0)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Employee Department Chart
    const employeeCtx = document.getElementById('employeeChart');
    if (employeeCtx) {
        new Chart(employeeCtx, {
            type: 'polarArea',
            data: {
                labels: ['IT', 'HR', 'Finance', 'Operations', 'Marketing'],
                datasets: [{
                    data: [12, 8, 6, 15, 5],
                    backgroundColor: [
                        'rgba(74, 110, 245, 0.7)',
                        'rgba(124, 92, 255, 0.7)',
                        'rgba(0, 212, 255, 0.7)',
                        'rgba(0, 204, 153, 0.7)',
                        'rgba(255, 149, 0, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    {% endif %}
</script>
{% endblock %}
