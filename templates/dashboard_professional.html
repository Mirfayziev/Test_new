{% extends "base.html" %}
{% block page_title %}Rahbar Paneli{% endblock %}

{% block extra_css %}
<style>
/* Sidebar uchun styling */
.sidebar-menu {
    width: 260px;
    background: #0f172a;
    height: 100vh;
    padding-top: 20px;
    color: white;
    position: fixed;
    left: 0;
    top: 0;
}

.sidebar-item {
    padding: 14px 22px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    border-radius: 10px;
    margin: 6px 12px;
    color: #e2e8f0;
    transition: 0.25s;
}

.sidebar-item:hover,
.sidebar-item.active {
    background: #1e293b;
    color: white;
}

/* Asosiy konteyner */
.main-content {
    margin-left: 275px;
    padding: 20px;
}

/* Upper stats boxlar */
.stat-box {
    background: #ffffff;
    border-radius: 18px;
    padding: 22px;
    box-shadow: 0 5px 18px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 18px;
    transition: 0.3s;
}

.stat-box:hover {
    transform: translateY(-4px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    color: white;
}

.stat-value {
    font-size: 30px;
    font-weight: 700;
}

.stat-label {
    font-size: 14px;
    opacity: 0.7;
}

/* Cards */
.cardx {
    background: white;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.07);
    margin-bottom: 22px;
}

.card-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 12px;
}

/* Transport blok */
.car-item {
    display: flex;
    background: #f8fafc;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 8px;
    align-items: center;
}

.car-photo {
    width: 72px;
    height: 54px;
    border-radius: 10px;
    background: #cbd5e1;
}

</style>
{% endblock %}

{% block content %}

<div class="sidebar-menu">
    <div class="sidebar-item active"><i class="bi bi-columns-gap"></i> Panel</div>
    <div class="sidebar-item"><i class="bi bi-list-check"></i> Topshiriqlar</div>
    <div class="sidebar-item"><i class="bi bi-car-front"></i> Avtopark</div>
    <div class="sidebar-item"><i class="bi bi-people"></i> Xodimlar</div>
    <div class="sidebar-item"><i class="bi bi-file-text"></i> Shartnomalar</div>
</div>

<div class="main-content">

    <h2 class="mb-4 fw-bold">Rahbar Paneli</h2>

    <div class="row g-4 mb-4">
        <div class="col-xxl-3 col-md-6">
            <div class="stat-box">
                <div class="stat-icon" style="background:#f97316;">
                    <i class="bi bi-list-task"></i>
                </div>
                <div>
                    <div class="stat-value">{{ stats.total_tasks }}</div>
                    <div class="stat-label">Jami topshiriqlar</div>
                </div>
            </div>
        </div>

        <div class="col-xxl-3 col-md-6">
            <div class="stat-box">
                <div class="stat-icon" style="background:#22c55e;">
                    <i class="bi bi-check2-circle"></i>
                </div>
                <div>
                    <div class="stat-value">{{ stats.completed_tasks }}</div>
                    <div class="stat-label">Bajarilganlar</div>
                </div>
            </div>
        </div>

        <div class="col-xxl-3 col-md-6">
            <div class="stat-box">
                <div class="stat-icon" style="background:#ef4444;">
                    <i class="bi bi-x-octagon"></i>
                </div>
                <div>
                    <div class="stat-value">{{ stats.overdue_tasks }}</div>
                    <div class="stat-label">Muddati o‘tgan</div>
                </div>
            </div>
        </div>

        <div class="col-xxl-3 col-md-6">
            <div class="stat-box">
                <div class="stat-icon" style="background:#0ea5e9;">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div>
                    <div class="stat-value">{{ format_money(stats.total_amount) }}</div>
                    <div class="stat-label">Umumiy summa</div>
                </div>
            </div>
        </div>
    </div>
    <!-- 2-QATOR: 3ta katta blok -->
    <div class="row g-4 mb-4">

        <!-- Chap blok: Tushgan topshiriqlar -->
        <div class="col-xl-3 col-lg-4">
            <div class="cardx">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="card-title">Tushgan topshiriqlar</div>
                    <i class="bi bi-three-dots-vertical"></i>
                </div>

                {% set ts = tasks_summary|default({}) %}
                <div class="p-2 rounded-3 bg-light mb-2 d-flex justify-content-between">
                    <div><i class="bi bi-hourglass text-warning me-2"></i>Yangi</div>
                    <div class="fw-bold">{{ ts.new|default(0) }}</div>
                </div>
                <div class="p-2 rounded-3 bg-light mb-2 d-flex justify-content-between">
                    <div><i class="bi bi-arrow-repeat text-primary me-2"></i>Jarayonda</div>
                    <div class="fw-bold">{{ ts.in_progress|default(0) }}</div>
                </div>
                <div class="p-2 rounded-3 bg-light mb-3 d-flex justify-content-between">
                    <div><i class="bi bi-check2-circle text-success me-2"></i>Bajarilgan</div>
                    <div class="fw-bold">{{ ts.done|default(0) }}</div>
                </div>

                <div class="small text-muted mb-2">Oxirgi topshiriqlar</div>
                <div class="d-flex flex-column gap-2">
                    {% for t in recent_tasks|default([]) %}
                    <div class="d-flex align-items-center justify-content-between p-2 rounded-3 bg-light">
                        <div class="d-flex align-items-center gap-2">
                            <div class="rounded-circle bg-secondary" style="width:28px;height:28px;"></div>
                            <div>
                                <div class="fw-semibold small">{{ t.title }}</div>
                                <div class="text-muted" style="font-size:12px;">{{ t.created_at }}</div>
                            </div>
                        </div>
                        <span class="badge bg-{{ 'success' if t.status=='completed' else 'warning' }}">
                            {{ t.status }}
                        </span>
                    </div>
                    {% else %}
                    <div class="text-muted small">Hozircha topshiriq yo‘q</div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tadbirlar & Mehmonlar -->
            <div class="cardx">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="card-title">Tadbirlar & Mehmonlar</div>
                    <i class="bi bi-calendar-event"></i>
                </div>

                {% for e in events|default([]) %}
                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded-3 mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <div class="rounded bg-primary-subtle text-primary fw-bold"
                             style="width:34px;height:34px;display:flex;align-items:center;justify-content:center;">
                            {{ loop.index }}
                        </div>
                        <div>
                            <div class="fw-semibold small">{{ e.title }}</div>
                            <div class="text-muted" style="font-size:12px;">{{ e.date }}</div>
                        </div>
                    </div>
                    <div class="fw-bold small">{{ e.amount }}</div>
                </div>
                {% else %}
                <div class="text-muted small">Tadbirlar yo‘q</div>
                {% endfor %}
            </div>
        </div>

        <!-- O'rta blok: Avto transportlar -->
        <div class="col-xl-5 col-lg-8">
            <div class="cardx h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="card-title">Avto transportlar</div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary">Barchasi</button>
                        <button class="btn btn-sm btn-primary">Jadval</button>
                    </div>
                </div>

                <div class="table-responsive mt-2">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width:90px;">Avto</th>
                                <th>Davlat raqami</th>
                                <th>Masofa</th>
                                <th>Holat</th>
                                <th>Yoqilg‘i</th>
                                <th>Baholash</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in vehicles|default([]) %}
                            <tr>
                                <td>
                                    <div class="car-photo"></div>
                                </td>
                                <td class="fw-semibold">{{ v.number }}</td>
                                <td>{{ v.mileage }} km</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if v.status=='active' else 'secondary' }}">
                                        {{ v.status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="text-{{ 'success' if v.fuel_ok else 'danger' }}">
                                        {{ v.fuel|default('—') }}
                                    </span>
                                </td>
                                <td>{{ v.rating|default('—') }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6" class="text-muted small">Avtotransportlar yo‘q</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="small text-muted">Ko‘rsatilmoqda {{ vehicles|default([])|length }} ta</div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary">&laquo;</button>
                        <button class="btn btn-sm btn-outline-secondary">1</button>
                        <button class="btn btn-sm btn-outline-secondary">2</button>
                        <button class="btn btn-sm btn-outline-secondary">&raquo;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- O'ng blok: Shartnomalar -->
        <div class="col-xl-4 col-lg-12">
            <div class="cardx h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="card-title">Shartnomalar</div>
                    <i class="bi bi-box-arrow-up-right"></i>
                </div>

                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Nom</th>
                                <th>Soni</th>
                                <th>Summa</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in contracts|default([]) %}
                            <tr>
                                <td>{{ c.name }}</td>
                                <td class="fw-semibold">{{ c.count }}</td>
                                <td class="fw-semibold">{{ c.amount }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-muted small">Shartnomalar yo‘q</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-2 text-end">
                    <a href="{{ url_for('contracts') if 'contracts' in globals() else '#' }}"
                       class="btn btn-sm btn-outline-primary">Barchasini ko‘rish</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row g-4">

        <!-- Past o‘rta: Autorsing xizmatlari -->
        <div class="col-xl-5 col-lg-6">
            <div class="cardx">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="card-title">Autorsing xizmatlari</div>
                    <i class="bi bi-three-dots"></i>
                </div>

                <div class="d-flex flex-column gap-2">
                    {% for s in suppliers|default([]) %}
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded-3">
                        <div class="d-flex align-items-center gap-2">
                            <div class="rounded-circle bg-primary-subtle text-primary fw-bold"
                                 style="width:34px;height:34px;display:flex;align-items:center;justify-content:center;">
                                {{ s.short|default('A') }}
                            </div>
                            <div>
                                <div class="fw-semibold small">{{ s.name }}</div>
                                <div class="text-muted" style="font-size:12px;">{{ s.service }}</div>
                            </div>
                        </div>
                        <div class="small fw-bold">{{ s.amount }}</div>
                    </div>
                    {% else %}
                    <div class="text-muted small">Ro‘yxat bo‘sh</div>
                    {% endfor %}
                </div>

                <div class="mt-3 d-flex justify-content-between">
                    <button class="btn btn-sm btn-outline-secondary">Oldingi</button>
                    <button class="btn btn-sm btn-primary">Keyingi</button>
                </div>
            </div>
        </div>

        <!-- Past o‘ng: Xodimlar topshiriqlari & KPI -->
        <div class="col-xl-7 col-lg-6">
            <div class="cardx">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="card-title">Xodimlar topshiriqlari & KPI ko‘rsatkichlari</div>
                    <i class="bi bi-graph-up-arrow"></i>
                </div>

                <div class="row g-3">
                    <!-- KPI mini chart -->
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold">Hafta KPI</div>
                                <div class="small text-muted">Bugun</div>
                            </div>

                            {% set ss = staff_stats|default({}) %}
                            <div class="display-6 fw-bold">{{ ss.total|default(0) }}</div>
                            <div class="small text-muted mb-2">Topshiriqlar</div>

                            <!-- fake bars (1:1 ko‘rinish uchun) -->
                            <div style="height:110px;display:flex;align-items:flex-end;gap:6px;">
                                <div style="width:18%;height:45%;background:#94a3b8;border-radius:6px;"></div>
                                <div style="width:18%;height:70%;background:#60a5fa;border-radius:6px;"></div>
                                <div style="width:18%;height:55%;background:#34d399;border-radius:6px;"></div>
                                <div style="width:18%;height:85%;background:#60a5fa;border-radius:6px;"></div>
                                <div style="width:18%;height:62%;background:#94a3b8;border-radius:6px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- KPI big line chart style -->
                    <div class="col-md-8">
                        <div class="p-3 rounded-3 text-white"
                             style="background:linear-gradient(135deg,#0f172a,#1d4ed8);min-height:210px;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-semibold">Faollik grafigi</div>
                                <div class="small opacity-75">Oy bo‘yicha</div>
                            </div>

                            <div class="mt-3 d-flex gap-4">
                                <div>
                                    <div class="display-6 fw-bold">{{ ss.new|default(0) }}</div>
                                    <div class="small opacity-75">Yangi</div>
                                </div>
                                <div>
                                    <div class="display-6 fw-bold">{{ ss.in_progress|default(0) }}</div>
                                    <div class="small opacity-75">Jarayonda</div>
                                </div>
                                <div>
                                    <div class="display-6 fw-bold">{{ ss.done|default(0) }}</div>
                                    <div class="small opacity-75">Bajarildi</div>
                                </div>
                            </div>

                            <!-- Fake line for 1:1 view -->
                            <div class="mt-3" style="height:110px;background:rgba(255,255,255,0.08);border-radius:10px;position:relative;">
                                <div style="position:absolute;left:10px;right:10px;bottom:15px;height:2px;background:rgba(255,255,255,0.25);"></div>
                                <svg viewBox="0 0 100 30" preserveAspectRatio="none"
                                     style="width:100%;height:100%;position:absolute;left:0;top:0;">
                                    <polyline fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="2"
                                              points="0,25 15,18 30,20 45,12 60,15 75,8 90,10 100,6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- pastki kichik servis tugmalar -->
                <div class="mt-3 d-flex justify-content-between align-items-center">
                    <div class="small text-muted">So‘nggi yangilanish: {{ last_update|default('hozir') }}</div>
                    <a href="{{ url_for('analytics') if 'analytics' in globals() else '#' }}"
                       class="btn btn-sm btn-outline-secondary">Analitika</a>
                </div>
            </div>
        </div>

    </div> <!-- row end -->

</div> <!-- main-content end -->

{% endblock %}
